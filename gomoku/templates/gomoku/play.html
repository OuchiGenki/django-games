{% extends 'base.html' %}
{% load static %}
{% block title %}オセロ{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'gomoku/play.css' %}">
{% endblock %}

{% block content %}
<div class="container py-4">
  <div id="game-over-banner" class="w-100 mb-3 {% if not game.is_finished %}d-none{% endif %}">
    <div class="alert alert-secondary text-center mb-0" role="alert">
      ゲーム終了{% if game.winner %} — 勝者: <span id="winner-name">{{ game.winner }}</span>{% endif %}
    </div>
  </div>
  <div class="row">
    <!-- メイン：ボードと操作 -->
    <div class="col-md-8">
      <div class="card mb-3">
        <div class="card-header">五目並べ</div>
        <div class="card-body d-flex flex-column align-items-center">
          <!-- ボード表示領域（JSで描画する想定） -->
          <div id="board-wrapper" class="w-100 d-flex justify-content-center mb-3">
            <table id="board" class="bg-light border rounded m-0 p-0" cellpadding="0" cellspacing="0">
            <tbody>
                {% for row in game.board %}
                <tr>
                    {% for color in row %}
                    <td class="cell">
                        {% if color == 'B' %}
                        <button class="cell-btn black-stone"></button>
                        {% elif color == 'W' %}
                        <button class="cell-btn white-stone"></button>
                        {% else %}
                        <button class="cell-btn empty-cell" onclick="fetchBoardState({{ forloop.parentloop.counter0 }}, {{ forloop.counter0 }})"></button>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card mb-3">
        <div class="card-header">ゲーム情報</div>
        <div class="card-body">
          <p class="mb-1">ターン: <span id="turn" class="fw-bold">{% if game.current_turn == 'B' %}黒{% else %}白{% endif %}</span></p>
          <hr>
          <h6 class="mb-2">プレイヤー</h6>
          <ul class="list-unstyled">
            <li>先手: <strong id="player-black">黒</strong></li>
            <li>後手: <strong id="player-white">白</strong></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block script %}
<script>
function fetchBoardState(row, col) {
    const finishedBanner = document.getElementById('game-over-banner');
    if (finishedBanner && !finishedBanner.classList.contains('d-none')) {
        return ;
    }

    const baseUrl = "{% url 'gomoku:api_move' %}";
    fetch(`${baseUrl}?row=${row}&col=${col}&game_id={{ game.id }}`)
        .then(response => response.json())
        .then(data => {
            let is_finished = data.is_finished;
            let current_turn = data.current_turn;
            let board = data.board;

            updateBoard(board);
            updateTurn(current_turn);

            if (is_finished) {
                const banner = document.getElementById('game-over-banner');
                banner.classList.remove('d-none');
                location.reload();
            }
        })
}

function updateBoard(board) {
    buttons = document.getElementsByClassName('cell-btn');
    for (let row = 0; row < board.length; row++) {
        for (let col = 0; col < board[row].length; col++) {
            btn = buttons[row * board.length + col];
            if (board[row][col] == 'B') {
                btn.classList.add('black-stone');
            } else if (board[row][col] == 'W') {
                btn.classList.add('white-stone');
            }
        }
    }
}

function updateTurn(current_turn) {
    const turn = document.getElementById('turn');
    turn.textContent = current_turn == 'B' ? '黒' : '白';
}
</script>
{% endblock %}